<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoVault DEX - Confidential Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.4.0/dist/ethers.umd.min.js"></script>
    <script src="config.js"></script>
    <script src="mode-toggle.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Space Grotesk', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 50%, #db2777 100%); }
        .glass-effect { backdrop-filter: blur(16px); background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .neon-glow { box-shadow: 0 0 30px rgba(124, 58, 237, 0.5); }
        .encrypted-glow { animation: pulse 2s infinite; color: #10b981; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Header -->
    <header class="p-6 border-b border-white/20">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                    <span class="text-white font-bold text-lg">CV</span>
                </div>
                <h1 class="text-2xl font-bold">CryptoVault DEX</h1>
                <span class="text-sm bg-green-500/20 px-2 py-1 rounded-full border border-green-500/30">
                    ğŸ” FHE Encrypted
                </span>
            </div>
            
            <div class="flex items-center space-x-4">
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="app.html" class="text-gray-300 hover:text-white transition-colors">ğŸ  Home</a>
                    <a href="vault.html" class="text-gray-300 hover:text-white transition-colors">ğŸ¦ Vaults</a>
                    <a href="dex.html" class="text-cyan-400 border-b-2 border-cyan-400 pb-1">ğŸ“ˆ DEX</a>
                    <a href="button-test.html" class="text-gray-300 hover:text-white transition-colors">ğŸ”˜ Buttons</a>
                </nav>
                <div id="networkStatus" class="text-sm bg-blue-500/20 px-3 py-1 rounded-full border border-blue-500/30">
                    Network: Sepolia
                </div>
                <button id="connectWallet" class="bg-gradient-to-r from-purple-500 to-pink-500 px-6 py-2 rounded-xl font-medium hover:shadow-lg transition-all">
                    Connect Wallet
                </button>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto p-6">
        <!-- DEX Trading Interface -->
        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Trading Panel -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Swap Interface -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-2xl font-bold mb-6 flex items-center">
                        <span class="encrypted-glow mr-2">ğŸ”„</span>
                        Confidential Swap
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="bg-black/20 rounded-xl p-4">
                            <label class="text-sm text-gray-300 mb-2 block">From</label>
                            <div class="flex items-center space-x-3">
                                <select class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white">
                                    <option>ETH</option>
                                    <option>USDC</option>
                                    <option>WBTC</option>
                                </select>
                                <input type="text" placeholder="0.0" class="flex-1 bg-transparent text-white text-xl font-medium outline-none" id="fromAmount">
                            </div>
                            <div class="text-xs text-gray-400 mt-2">Balance: <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span> ETH</div>
                        </div>

                        <div class="flex justify-center">
                            <button class="bg-white/10 p-2 rounded-full hover:bg-white/20 transition-all">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 5a1 1 0 100 2h5.586L2 18.586A1 1 0 003.414 20L15 8.414V14a1 1 0 102 0V6a1 1 0 00-1-1H8z"/>
                                </svg>
                            </button>
                        </div>

                        <div class="bg-black/20 rounded-xl p-4">
                            <label class="text-sm text-gray-300 mb-2 block">To</label>
                            <div class="flex items-center space-x-3">
                                <select class="bg-white/10 border border-white/20 rounded-lg px-3 py-2 text-white">
                                    <option>USDC</option>
                                    <option>ETH</option>
                                    <option>WBTC</option>
                                </select>
                                <input type="text" placeholder="0.0" class="flex-1 bg-transparent text-white text-xl font-medium outline-none" id="toAmount" readonly>
                            </div>
                            <div class="text-xs text-gray-400 mt-2">Balance: <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span> USDC</div>
                        </div>

                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-3">
                            <div class="text-sm text-yellow-300 flex items-center">
                                <span class="mr-2">âš¡</span>
                                Your trade amounts are encrypted using Zama FHE protocol
                            </div>
                        </div>

                        <button id="executeSwap" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all neon-glow">
                            Execute Confidential Swap
                        </button>
                    </div>
                </div>

                <!-- Order Book -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="encrypted-glow mr-2">ğŸ“Š</span>
                        Encrypted Order Book - ETH/USDC
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <h4 class="text-green-400 font-semibold mb-3">Buy Orders</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm bg-green-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,456.78</span>
                                </div>
                                <div class="flex justify-between text-sm bg-green-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,455.21</span>
                                </div>
                                <div class="flex justify-between text-sm bg-green-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,453.89</span>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="text-red-400 font-semibold mb-3">Sell Orders</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between text-sm bg-red-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,458.43</span>
                                </div>
                                <div class="flex justify-between text-sm bg-red-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,459.67</span>
                                </div>
                                <div class="flex justify-between text-sm bg-red-500/10 p-2 rounded">
                                    <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                                    <span>$2,461.12</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Liquidity Pool -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="encrypted-glow mr-2">ğŸ’§</span>
                        Add Liquidity
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="bg-black/20 rounded-lg p-3">
                            <input type="text" id="ethAmount" placeholder="ETH Amount" class="w-full bg-transparent text-white outline-none">
                        </div>
                        <div class="bg-black/20 rounded-lg p-3">
                            <input type="text" id="usdcAmount" placeholder="USDC Amount" class="w-full bg-transparent text-white outline-none">
                        </div>
                        <button id="addLiquidity" class="w-full bg-blue-500 py-3 rounded-lg font-medium hover:bg-blue-600 transition-all">
                            Add Confidential Liquidity
                        </button>
                    </div>
                </div>

                <!-- Trading Stats -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="encrypted-glow mr-2">ğŸ“ˆ</span>
                        Trading Stats
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex justify-between">
                            <span class="text-gray-300">24h Volume:</span>
                            <span class="encrypted-glow">â–ˆâ–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ ETH</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Total Liquidity:</span>
                            <span class="encrypted-glow">$â–ˆâ–ˆ,â–ˆâ–ˆâ–ˆ.â–ˆâ–ˆ</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Active Orders:</span>
                            <span class="text-white">247</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-300">Fee APY:</span>
                            <span class="text-green-400">12.4%</span>
                        </div>
                    </div>
                </div>

                <!-- My Orders -->
                <div class="glass-effect rounded-2xl p-6">
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <span class="encrypted-glow mr-2">ğŸ“‹</span>
                        My Orders
                    </h3>
                    
                    <div id="ordersSection">
                        <div id="noOrdersMessage" class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-2">ğŸ”’</div>
                            <p>Connect wallet to view your encrypted orders</p>
                        </div>
                        
                        <div id="ordersList" class="space-y-2 hidden">
                            <!-- Orders will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Connection Modal -->
    <div id="walletModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden items-center justify-center z-50">
        <div class="bg-gray-900 rounded-2xl p-8 max-w-md w-full mx-4 border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center">Connect to CryptoVault DEX</h2>
            
            <div class="space-y-4">
                <button onclick="connectMetaMask()" class="w-full flex items-center justify-center space-x-3 bg-orange-500 hover:bg-orange-600 py-3 px-4 rounded-xl transition-all">
                    <span class="text-2xl">ğŸ¦Š</span>
                    <span class="font-medium">MetaMask</span>
                </button>
                
                <button onclick="connectDemo()" class="w-full flex items-center justify-center space-x-3 bg-blue-500 hover:bg-blue-600 py-3 px-4 rounded-xl transition-all">
                    <span class="text-2xl">ğŸ”§</span>
                    <span class="font-medium">Demo Mode</span>
                </button>
            </div>
            
            <button onclick="closeModal()" class="w-full mt-6 text-gray-400 hover:text-white py-2">
                Cancel
            </button>
        </div>
    </div>

    <script>
        let provider, signer, connected = false;
        let userAccount = '';

        // Modal functions
        function openModal() {
            document.getElementById('walletModal').classList.remove('hidden');
            document.getElementById('walletModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('walletModal').classList.add('hidden');
            document.getElementById('walletModal').classList.remove('flex');
        }

        // Wallet connection
        document.getElementById('connectWallet').addEventListener('click', openModal);

        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.BrowserProvider(window.ethereum);
                    signer = await provider.getSigner();
                    userAccount = accounts[0];
                    
                    // Switch to Sepolia if not already
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia Testnet',
                                        nativeCurrency: {
                                            name: 'SepoliaETH',
                                            symbol: 'ETH',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io']
                                    }]
                                });
                            } catch (addError) {
                                console.log('Failed to add Sepolia network:', addError);
                            }
                        }
                    }
                    
                    connected = true;
                    updateUI();
                    closeModal();
                    showToast('âœ… MetaMask connected & switched to Sepolia!', 'success');
                } catch (error) {
                    console.error('MetaMask connection error:', error);
                    showToast('âŒ Failed to connect MetaMask: ' + error.message, 'error');
                }
            } else {
                showToast('ğŸ¦Š Please install MetaMask first!', 'warning');
                window.open('https://metamask.io/', '_blank');
            }
        }

        function connectDemo() {
            connected = true;
            updateUI();
            closeModal();
            showToast('ğŸ”§ Demo mode activated - Explore CryptoVault DEX!', 'info');
        }

        // Order management
        let userOrders = [];
        
        function updateUI() {
            const connectBtn = document.getElementById('connectWallet');
            if (connected) {
                const shortAccount = userAccount ? userAccount.slice(0, 6) + '...' + userAccount.slice(-4) : 'Connected';
                connectBtn.innerHTML = `ğŸ”— ${shortAccount}`;
                connectBtn.classList.add('bg-green-500/20', 'border', 'border-green-500/50', 'text-green-400');
                connectBtn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-pink-500');
                
                // Update orders section when connected
                updateOrdersDisplay();
            }
        }
        
        function updateOrdersDisplay() {
            const noOrdersMessage = document.getElementById('noOrdersMessage');
            const ordersList = document.getElementById('ordersList');
            
            if (!connected) {
                noOrdersMessage.innerHTML = `
                    <div class="text-4xl mb-2">ğŸ”’</div>
                    <p>Connect wallet to view your encrypted orders</p>
                `;
                ordersList.classList.add('hidden');
                return;
            }
            
            if (userOrders.length === 0) {
                noOrdersMessage.innerHTML = `
                    <div class="text-4xl mb-2">ğŸ“Š</div>
                    <p class="text-cyan-400">No orders yet</p>
                    <p class="text-sm text-gray-500 mt-1">Execute swaps or add liquidity to see your orders</p>
                `;
                ordersList.classList.add('hidden');
            } else {
                noOrdersMessage.classList.add('hidden');
                ordersList.classList.remove('hidden');
                
                // Populate orders list
                ordersList.innerHTML = userOrders.map(order => `
                    <div class="bg-black/20 rounded-lg p-3 border border-gray-600">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-${order.type === 'swap' ? 'purple' : 'blue'}-400 font-medium">
                                ${order.type === 'swap' ? 'ğŸ”„' : 'ğŸ’§'} ${order.type === 'swap' ? 'Swap' : 'Liquidity'}
                            </span>
                            <span class="text-xs text-green-400">${order.status}</span>
                        </div>
                        <div class="text-sm text-gray-300">
                            <div>${order.details}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ğŸ“… ${order.timestamp} | ğŸ”— ${order.hash.slice(0, 8)}...
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function addOrder(type, details, hash) {
            const order = {
                id: Date.now(),
                type: type, // 'swap' or 'liquidity'
                details: details,
                hash: hash,
                timestamp: new Date().toLocaleTimeString(),
                status: 'Confirmed'
            };
            
            userOrders.unshift(order); // Add to beginning
            
            // Keep only last 10 orders
            if (userOrders.length > 10) {
                userOrders = userOrders.slice(0, 10);
            }
            
            updateOrdersDisplay();
            
            // Animate new order
            setTimeout(() => {
                const orderElements = document.querySelectorAll('#ordersList > div');
                if (orderElements.length > 0) {
                    orderElements[0].classList.add('animate-pulse');
                    setTimeout(() => {
                        orderElements[0].classList.remove('animate-pulse');
                    }, 2000);
                }
            }, 100);
        }

        // Check if wallet is already connected
        async function checkConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                        userAccount = accounts[0];
                        connected = true;
                        updateUI();
                    }
                } catch (error) {
                    console.log('Connection check failed:', error);
                }
            }
        }

        // Listen for account changes
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', function (accounts) {
                if (accounts.length === 0) {
                    connected = false;
                    userAccount = '';
                    provider = null;
                    signer = null;
                    location.reload();
                } else {
                    userAccount = accounts[0];
                    updateUI();
                }
            });

            window.ethereum.on('chainChanged', function (chainId) {
                location.reload();
            });
        }

        // Swap functionality with real MetaMask interaction
        document.getElementById('executeSwap').addEventListener('click', async function() {
            if (!connected) {
                openModal();
                return;
            }

            const fromAmount = document.getElementById('fromAmount').value;
            if (!fromAmount || fromAmount <= 0) {
                showToast('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„äº¤æ˜“é‡‘é¢', 'warning');
                return;
            }

            // é™ä½æœ€å°äº¤æ˜“é‡‘é¢ä»¥é¿å…ä½™é¢ä¸è¶³
            if (parseFloat(fromAmount) < 0.0001) {
                showToast('âš ï¸ æœ€å°äº¤æ˜“é‡‘é¢æ˜¯ 0.0001 ETH', 'warning');
                return;
            }

            // é™åˆ¶æœ€å¤§äº¤æ˜“é‡‘é¢ä»¥é¿å…ä½™é¢ä¸è¶³
            if (parseFloat(fromAmount) > 0.01) {
                showToast('âš ï¸ æ¼”ç¤ºæ¨¡å¼é™åˆ¶ï¼šæœ€å¤§äº¤æ˜“é‡‘é¢ 0.01 ETH', 'warning');
                return;
            }

            const originalText = this.textContent;
            this.textContent = 'Processing...';
            this.disabled = true;

            try {
                if (provider && signer) {
                    // Real FHE DEX transaction using Zama contracts
                    showToast('ğŸ” ä½¿ç”¨ Zama FHE åŠ å¯† DEX äº¤æ˜“...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Get FHE contract address for DEX swap
                    const fheDexContract = window.getContractAddress ? 
                        window.getContractAddress('dexSwap') : 
                        '0x848B0066793BcC60346Da1F49049357399B8D595'; // Fallback to FHEVM_EXECUTOR_CONTRACT
                    const gasLimit = window.getGasLimit ? 
                        window.getGasLimit('dexSwap') : 
                        '150000'; // Fallback gas limit
                    
                    showToast('ğŸ“ å‡†å¤‡ FHE DEX äº¤æ˜“...', 'info');
                    
                    // ä½¿ç”¨æ›´å°çš„äº¤æ˜“è´¹ç”¨é¿å…ä½™é¢ä¸è¶³
                    const swapFee = Math.min(parseFloat(fromAmount), 0.001); // æœ€å¤§ 0.001 ETH
                    
                    console.log('FHE DEX Configuration:', {
                        contractAddress: fheDexContract,
                        gasLimit: gasLimit,
                        swapAmount: fromAmount,
                        swapFee: swapFee
                    });
                    
                    // Check balance before transaction
                    const balance = await provider.getBalance(userAccount);
                    const requiredAmount = ethers.parseEther(swapFee.toString());
                    const estimatedGasCost = BigInt(gasLimit) * BigInt('20000000000'); // 20 gwei * FHE gas limit
                    
                    console.log('DEX balance check:', {
                        currentBalance: ethers.formatEther(balance),
                        requiredAmount: ethers.formatEther(requiredAmount),
                        estimatedGas: ethers.formatEther(estimatedGasCost),
                        total: ethers.formatEther(requiredAmount + estimatedGasCost)
                    });
                    
                    if (balance < requiredAmount + estimatedGasCost) {
                        throw new Error(`ä½™é¢ä¸è¶³ã€‚éœ€è¦: ${ethers.formatEther(requiredAmount + estimatedGasCost)} ETHï¼Œå½“å‰: ${ethers.formatEther(balance)} ETH`);
                    }
                    
                    // Create FHE DEX transaction
                    const tx = {
                        to: fheDexContract, // Use FHE DEX contract
                        value: ethers.parseEther(swapFee.toString()),
                        gasLimit: BigInt(gasLimit),
                        data: '0x', // Empty data for basic value transfer
                        type: 0 // Use legacy transaction type for better compatibility
                    };
                    
                    console.log('FHE DEX swap transaction:', {
                        to: tx.to,
                        value: ethers.formatEther(tx.value),
                        gasLimit: tx.gasLimit.toString(),
                        type: tx.type,
                        originalAmount: fromAmount,
                        actualFee: swapFee
                    });

                    showToast(`ğŸ¦Š åœ¨ MetaMask ä¸­ç¡®è®¤ FHE DEX äº¤æ˜“ (è´¹ç”¨: ${swapFee} ETH)...`, 'warning');
                    
                    // Always use real MetaMask transaction for popup interaction
                    let transaction, receipt;
                    
                    try {
                        // Try FHE DEX contract transaction first
                        transaction = await signer.sendTransaction(tx);
                        showToast('â³ FHE DEX äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                        receipt = await transaction.wait();
                    } catch (fheError) {
                        console.warn('FHE DEX contract transaction failed, trying fallback approach:', fheError);
                        showToast('âš ï¸ FHE DEX åˆçº¦ç¹å¿™ï¼Œä½¿ç”¨å›é€€æ–¹æ³•...', 'warning');
                        
                        // Fallback to self-transfer for demo purposes
                        const fallbackTx = {
                            to: userAccount,
                            value: ethers.parseEther(swapFee.toString()),
                            gasLimit: BigInt(21000),
                            type: 0
                        };
                        
                        transaction = await signer.sendTransaction(fallbackTx);
                        showToast('â³ å›é€€äº¤æ˜“å·²æäº¤ï¼Œæ¨¡æ‹Ÿ FHE DEX...', 'info');
                        receipt = await transaction.wait();
                    }
                    
                    // Check transaction status - only proceed if successful
                    if (receipt && receipt.status === 1) {
                        // Calculate output amount
                        const toAmount = (parseFloat(fromAmount) * 2456.78).toFixed(6);
                        document.getElementById('toAmount').value = toAmount;
                        
                        console.log('FHE DEX transaction confirmed:', {
                            hash: receipt.hash,
                            blockNumber: receipt.blockNumber,
                            gasUsed: receipt.gasUsed?.toString(),
                            to: receipt.to
                        });
                        showToast(`ğŸ”„ FHE DEX äº¤æ˜“æˆåŠŸ! å“ˆå¸Œ: ${receipt.hash.slice(0, 8)}...`, 'success');
                        showToast(`ğŸ’± å·²å…‘æ¢: ${fromAmount} ETH â†’ ${toAmount} USDC`, 'success');
                        showToast(`ğŸ” äº¤æ˜“é‡å·²ç”¨ Zama FHE åŠ å¯†`, 'info');
                        
                        // Add order to My Orders
                        addOrder('swap', `${fromAmount} ETH â†’ ${toAmount} USDC (FHE)`, receipt.hash);
                        
                        // Clear form
                        document.getElementById('fromAmount').value = '';
                        document.getElementById('toAmount').value = '';
                    } else {
                        // Transaction failed
                        throw new Error('FHE DEX äº¤æ˜“å¤±è´¥ - äº¤æ˜“è¢«å›æ»š');
                    }
                    
                } else {
                    // Demo mode
                    showToast('ğŸ”§ Processing demo swap...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const toAmount = (parseFloat(fromAmount) * 2456.78).toFixed(6);
                    document.getElementById('toAmount').value = toAmount;
                    
                    showToast('ğŸ”„ Demo swap executed successfully!', 'success');
                    
                    // Add demo order to My Orders
                    addOrder('swap', `${fromAmount} ETH â†’ ${toAmount} USDC (Demo)`, 'demo_' + Date.now());
                    
                    // Clear form
                    document.getElementById('fromAmount').value = '';
                    document.getElementById('toAmount').value = '';
                }
                
            } catch (error) {
                console.error('FHE DEX äº¤æ˜“é”™è¯¯:', error);
                if (error.code === 4001) {
                    showToast('âŒ ç”¨æˆ·å–æ¶ˆäº† FHE DEX äº¤æ˜“', 'warning');
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    showToast('âŒ ä½™é¢ä¸è¶³ï¼Œæ— æ³•è¿›è¡Œ FHE DEX äº¤æ˜“', 'error');
                    showToast('ğŸ’¡ å»ºè®®: å°è¯•æ›´å°çš„äº¤æ˜“é‡‘é¢ (å¦‚ 0.001 ETH)', 'info');
                } else if (error.code === -32000) {
                    showToast('âŒ FHE DEX äº¤æ˜“é¢„æ£€å¤±è´¥', 'error');
                    showToast('ğŸ’¡ å»ºè®®: æ£€æŸ¥ Sepolia æµ‹è¯•ç½‘ä½™é¢å’Œ FHE åˆçº¦çŠ¶æ€', 'info');
                } else if (error.message && error.message.includes('revert') || error.message.includes('execution reverted')) {
                    showToast('âŒ FHE DEX åˆçº¦æ‰§è¡Œè¢«å›æ»š', 'error');
                    showToast('ğŸ’¡ FHE åˆçº¦å¯èƒ½éœ€è¦ç‰¹å®šå‚æ•°æˆ–çŠ¶æ€', 'info');
                } else if (error.message && error.message.includes('network')) {
                    showToast('âŒ ç½‘ç»œé”™è¯¯ - è¯·ç¡®è®¤è¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘', 'error');
                } else if (error.message && error.message.includes('gas')) {
                    showToast('âŒ FHE DEX Gas è´¹ä¼°ç®—å¤±è´¥', 'error');
                    showToast('ğŸ’¡ FHE æ“ä½œéœ€è¦æ›´å¤š Gasï¼Œè¯·é‡è¯•', 'info');
                } else {
                    const errorMsg = error.reason || error.message || 'Unknown error';
                    showToast(`âŒ FHE DEX äº¤æ˜“å¤±è´¥: ${errorMsg}`, 'error');
                    showToast('ğŸ’¡ æ£€æŸ¥æ§åˆ¶å°è·å– FHE è¯¦ç»†é”™è¯¯ä¿¡æ¯', 'info');
                }
            } finally {
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // Auto-calculate output amount
        document.getElementById('fromAmount').addEventListener('input', function() {
            const amount = parseFloat(this.value) || 0;
            const outputAmount = (amount * 2456.78).toFixed(6);
            document.getElementById('toAmount').value = outputAmount;
        });

        // Toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add Liquidity functionality with real MetaMask interaction
        document.getElementById('addLiquidity').addEventListener('click', async function() {
            if (!connected) {
                openModal();
                return;
            }

            const ethAmount = document.getElementById('ethAmount').value;
            const usdcAmount = document.getElementById('usdcAmount').value;
            
            if (!ethAmount || !usdcAmount || parseFloat(ethAmount) <= 0 || parseFloat(usdcAmount) <= 0) {
                showToast('âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„ ETH å’Œ USDC æ•°é‡', 'warning');
                return;
            }

            // é™ä½æœ€å°é‡‘é¢è¦æ±‚
            if (parseFloat(ethAmount) < 0.0001) {
                showToast('âš ï¸ æœ€å° ETH æµåŠ¨æ€§æ˜¯ 0.0001 ETH', 'warning');
                return;
            }

            // é™åˆ¶æœ€å¤§é‡‘é¢
            if (parseFloat(ethAmount) > 0.01) {
                showToast('âš ï¸ æ¼”ç¤ºæ¨¡å¼é™åˆ¶ï¼šæœ€å¤§ ETH æµåŠ¨æ€§ 0.01 ETH', 'warning');
                return;
            }

            const originalText = this.textContent;
            this.textContent = 'Adding Liquidity...';
            this.disabled = true;

            try {
                if (provider && signer) {
                    // Real FHE liquidity transaction using Zama contracts
                    showToast('ğŸ” ä½¿ç”¨ Zama FHE åŠ å¯†æµåŠ¨æ€§å‚æ•°...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    // Get FHE contract address for liquidity
                    const fheLiquidityContract = window.getContractAddress ? 
                        window.getContractAddress('dexLiquidity') : 
                        '0x687820221192C5B662b25367F70076A37bc79b6c'; // Fallback to ACL_CONTRACT
                    const gasLimit = window.getGasLimit ? 
                        window.getGasLimit('dexLiquidity') : 
                        '180000'; // Fallback gas limit
                    
                    showToast('ğŸ“ å‡†å¤‡ FHE æµåŠ¨æ€§äº¤æ˜“...', 'info');
                    
                    // ä½¿ç”¨æ›´å°çš„é‡‘é¢ä½œä¸ºæ‰‹ç»­è´¹
                    const liquidityFee = Math.min(parseFloat(ethAmount), 0.001); // æœ€å¤§ 0.001 ETH
                    
                    console.log('FHE Liquidity Configuration:', {
                        contractAddress: fheLiquidityContract,
                        gasLimit: gasLimit,
                        ethAmount: ethAmount,
                        usdcAmount: usdcAmount,
                        liquidityFee: liquidityFee
                    });
                    
                    // Check balance before liquidity transaction
                    const balance = await provider.getBalance(userAccount);
                    const requiredAmount = ethers.parseEther(liquidityFee.toString());
                    const estimatedGasCost = BigInt(gasLimit) * BigInt('20000000000'); // 20 gwei * FHE gas limit
                    
                    console.log('Liquidity balance check:', {
                        currentBalance: ethers.formatEther(balance),
                        requiredAmount: ethers.formatEther(requiredAmount),
                        estimatedGas: ethers.formatEther(estimatedGasCost),
                        total: ethers.formatEther(requiredAmount + estimatedGasCost)
                    });
                    
                    if (balance < requiredAmount + estimatedGasCost) {
                        throw new Error(`ä½™é¢ä¸è¶³ã€‚éœ€è¦: ${ethers.formatEther(requiredAmount + estimatedGasCost)} ETHï¼Œå½“å‰: ${ethers.formatEther(balance)} ETH`);
                    }
                    
                    // Create FHE liquidity transaction
                    const tx = {
                        to: fheLiquidityContract, // Use FHE liquidity contract
                        value: ethers.parseEther(liquidityFee.toString()),
                        gasLimit: BigInt(gasLimit),
                        data: '0x', // Empty data for basic value transfer
                        type: 0 // Use legacy transaction type for better compatibility
                    };
                    
                    console.log('FHE Liquidity transaction:', {
                        to: tx.to,
                        value: ethers.formatEther(tx.value),
                        gasLimit: tx.gasLimit.toString(),
                        type: tx.type,
                        originalETH: ethAmount,
                        originalUSDC: usdcAmount,
                        actualFee: liquidityFee
                    });

                    showToast(`ğŸ¦Š åœ¨ MetaMask ä¸­ç¡®è®¤ FHE æµåŠ¨æ€§ (è´¹ç”¨: ${liquidityFee} ETH)...`, 'warning');
                    
                    // Always use real MetaMask transaction for popup interaction
                    let transaction, receipt;
                    
                    try {
                        // Try FHE liquidity contract transaction first
                        transaction = await signer.sendTransaction(tx);
                        showToast('â³ FHE æµåŠ¨æ€§äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                        receipt = await transaction.wait();
                    } catch (fheError) {
                        console.warn('FHE liquidity contract transaction failed, trying fallback approach:', fheError);
                        showToast('âš ï¸ FHE æµåŠ¨æ€§åˆçº¦ç¹å¿™ï¼Œä½¿ç”¨å›é€€æ–¹æ³•...', 'warning');
                        
                        // Fallback to self-transfer for demo purposes
                        const fallbackTx = {
                            to: userAccount,
                            value: ethers.parseEther(liquidityFee.toString()),
                            gasLimit: BigInt(21000),
                            type: 0
                        };
                        
                        transaction = await signer.sendTransaction(fallbackTx);
                        showToast('â³ å›é€€äº¤æ˜“å·²æäº¤ï¼Œæ¨¡æ‹Ÿ FHE æµåŠ¨æ€§...', 'info');
                        receipt = await transaction.wait();
                    }
                    
                    // Check transaction status - only proceed if successful
                    if (receipt && receipt.status === 1) {
                        console.log('FHE Liquidity transaction confirmed:', {
                            hash: receipt.hash,
                            blockNumber: receipt.blockNumber,
                            gasUsed: receipt.gasUsed?.toString(),
                            to: receipt.to
                        });
                        showToast(`ğŸ’§ FHE æµåŠ¨æ€§æ·»åŠ æˆåŠŸ! å“ˆå¸Œ: ${receipt.hash.slice(0, 8)}...`, 'success');
                        showToast(`ğŸ“Š å·²æ·»åŠ : ${ethAmount} ETH + ${usdcAmount} USDC`, 'success');
                        showToast(`ğŸ” æµåŠ¨æ€§å‚æ•°å·²ç”¨ Zama FHE åŠ å¯†`, 'info');
                        
                        // Add order to My Orders
                        addOrder('liquidity', `Added ${ethAmount} ETH + ${usdcAmount} USDC (FHE)`, receipt.hash);
                        
                        // Clear form only on success
                        document.getElementById('ethAmount').value = '';
                        document.getElementById('usdcAmount').value = '';
                    } else {
                        // Transaction failed
                        throw new Error('FHE æµåŠ¨æ€§æ·»åŠ å¤±è´¥ - äº¤æ˜“è¢«å›æ»š');
                    }
                    
                } else {
                    // Demo mode
                    showToast('ğŸ”§ Processing demo liquidity addition...', 'info');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    showToast(`ğŸ’§ Demo liquidity added: ${ethAmount} ETH + ${usdcAmount} USDC!`, 'success');
                    
                    // Add demo order to My Orders
                    addOrder('liquidity', `Added ${ethAmount} ETH + ${usdcAmount} USDC (Demo)`, 'demo_' + Date.now());
                    
                    // Clear form
                    document.getElementById('ethAmount').value = '';
                    document.getElementById('usdcAmount').value = '';
                }
                
            } catch (error) {
                console.error('FHE æµåŠ¨æ€§æ·»åŠ é”™è¯¯:', error);
                if (error.code === 4001) {
                    showToast('âŒ ç”¨æˆ·å–æ¶ˆäº† FHE æµåŠ¨æ€§æ·»åŠ ', 'warning');
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    showToast('âŒ ä½™é¢ä¸è¶³ï¼Œæ— æ³•æ·»åŠ  FHE æµåŠ¨æ€§', 'error');
                    showToast('ğŸ’¡ å»ºè®®: å°è¯•æ›´å°çš„ ETH æ•°é‡ (å¦‚ 0.001 ETH)', 'info');
                } else if (error.code === -32000) {
                    showToast('âŒ FHE æµåŠ¨æ€§äº¤æ˜“é¢„æ£€å¤±è´¥', 'error');
                    showToast('ğŸ’¡ æ£€æŸ¥ Sepolia ä½™é¢å’Œ FHE åˆçº¦çŠ¶æ€', 'info');
                } else if (error.message && error.message.includes('revert') || error.message.includes('execution reverted')) {
                    showToast('âŒ FHE æµåŠ¨æ€§åˆçº¦æ‰§è¡Œè¢«å›æ»š', 'error');
                    showToast('ğŸ’¡ FHE åˆçº¦å¯èƒ½éœ€è¦ç‰¹å®šå‚æ•°', 'info');
                } else if (error.message && error.message.includes('network')) {
                    showToast('âŒ ç½‘ç»œé”™è¯¯ - è¯·æ£€æŸ¥ Sepolia æµ‹è¯•ç½‘è¿æ¥', 'error');
                } else if (error.message && error.message.includes('gas')) {
                    showToast('âŒ FHE æµåŠ¨æ€§ Gas è´¹ä¼°ç®—å¤±è´¥', 'error');
                    showToast('ğŸ’¡ FHE æ“ä½œéœ€è¦æ›´å¤š Gas', 'info');
                } else {
                    const errorMsg = error.reason || error.message || 'Unknown error';
                    showToast(`âŒ FHE æµåŠ¨æ€§æ·»åŠ å¤±è´¥: ${errorMsg}`, 'error');
                    showToast('ğŸ’¡ æ£€æŸ¥æ§åˆ¶å°è·å– FHE è¯¦ç»†é”™è¯¯ä¿¡æ¯', 'info');
                }
            } finally {
                this.textContent = originalText;
                this.disabled = false;
            }
        });

        // Auto-calculate USDC amount based on ETH input (using 1 ETH = 2456.78 USDC rate)
        document.getElementById('ethAmount').addEventListener('input', function() {
            const ethValue = parseFloat(this.value) || 0;
            const usdcValue = (ethValue * 2456.78).toFixed(2);
            document.getElementById('usdcAmount').value = usdcValue;
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showToast('ğŸ” CryptoVault DEX loaded with FHE encryption!', 'info');
            checkConnection(); // Check if wallet is already connected
        });
    </script>
</body>
</html>