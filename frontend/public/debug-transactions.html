<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ CryptoVault äº¤æ˜“è°ƒè¯•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.4.0/dist/ethers.umd.min.js"></script>
    <script src="config.js"></script>
    <style>
        body { font-family: 'Arial', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #0f0f23 0%, #1a1a40 50%, #2d1b69 100%); }
        .glass-effect { backdrop-filter: blur(16px); background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); }
        .debug-code { font-family: 'Courier New', monospace; font-size: 12px; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <!-- Navigation -->
    <nav class="p-6 border-b border-white/10">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500 to-orange-600 flex items-center justify-center">
                    <span class="text-white font-bold text-xl">ğŸ”§</span>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">äº¤æ˜“è°ƒè¯•å·¥å…·</h1>
                    <p class="text-sm text-gray-400">CryptoVault Debug Console</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-6">
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="app.html" class="text-gray-300 hover:text-white transition-colors">ğŸ  Home</a>
                    <a href="vault.html" class="text-gray-300 hover:text-white transition-colors">ğŸ¦ Vaults</a>
                    <a href="dex.html" class="text-gray-300 hover:text-white transition-colors">ğŸ“ˆ DEX</a>
                    <a href="metamask-test.html" class="text-gray-300 hover:text-white transition-colors">ğŸ¦Š Test</a>
                    <a href="debug-transactions.html" class="text-cyan-400 border-b-2 border-cyan-400 pb-1">ğŸ”§ Debug</a>
                </nav>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">ğŸ”§ äº¤æ˜“è°ƒè¯•æ§åˆ¶å°</h1>
            <p class="text-gray-300">è¯Šæ–­å’Œä¿®å¤ CryptoVault äº¤æ˜“é—®é¢˜</p>
        </div>

        <!-- ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ -->
        <div class="glass-effect rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-3">ğŸ“Š</span>ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
            </h2>
            <div class="grid md:grid-cols-3 gap-4">
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400">MetaMask çŠ¶æ€</div>
                    <div id="metamaskStatus" class="text-lg font-bold">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400">ç½‘ç»œçŠ¶æ€</div>
                    <div id="networkStatus" class="text-lg font-bold">æ£€æŸ¥ä¸­...</div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400">è´¦æˆ·ä½™é¢</div>
                    <div id="balanceStatus" class="text-lg font-bold">æ£€æŸ¥ä¸­...</div>
                </div>
            </div>
            <button id="checkSystemBtn" class="mt-4 bg-blue-500 hover:bg-blue-600 px-6 py-3 rounded-xl font-medium">
                ğŸ”„ åˆ·æ–°ç³»ç»ŸçŠ¶æ€
            </button>
        </div>

        <!-- åˆçº¦åœ°å€éªŒè¯ -->
        <div class="glass-effect rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-3">ğŸ—ï¸</span>åˆçº¦åœ°å€éªŒè¯
            </h2>
            <div class="grid md:grid-cols-2 gap-4 debug-code">
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">FHEVM_EXECUTOR</div>
                    <div class="text-green-400" id="fhevm-addr">0x848B0066793BcC60346Da1F49049357399B8D595</div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">KMS_VERIFIER (åˆ›å»ºé¡¹ç›®)</div>
                    <div class="text-green-400" id="kms-addr">0x1364cBBf2cDF5032C47d8226a6f6FBD2AFCDacAC</div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">HCU_LIMIT (æŠ•èµ„)</div>
                    <div class="text-green-400" id="hcu-addr">0x594BB474275918AF9609814E68C61B1587c5F838</div>
                </div>
                <div class="bg-black/20 rounded-lg p-4">
                    <div class="text-sm text-gray-400 mb-2">ACL_CONTRACT (DEX)</div>
                    <div class="text-green-400" id="acl-addr">0x687820221192C5B662b25367F70076A37bc79b6c</div>
                </div>
            </div>
            <button id="verifyContractsBtn" class="mt-4 bg-purple-500 hover:bg-purple-600 px-6 py-3 rounded-xl font-medium">
                âœ… éªŒè¯åˆçº¦å¯è®¿é—®æ€§
            </button>
        </div>

        <!-- åˆ›å»ºé¡¹ç›®è°ƒè¯• -->
        <div class="glass-effect rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-3">ğŸš€</span>åˆ›å»ºé¡¹ç›®è°ƒè¯•
            </h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-300 mb-2">é¡¹ç›®åç§°</label>
                    <input type="text" id="debugProjectName" value="æµ‹è¯•é¡¹ç›®" 
                           class="w-full bg-black/30 border border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">åˆ›å»ºè´¹ç”¨ (ETH)</label>
                    <input type="number" id="debugCreationFee" value="0.002" step="0.001" 
                           class="w-full bg-black/30 border border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
                <div>
                    <label class="block text-sm text-gray-300 mb-2">Gas Limit</label>
                    <input type="number" id="debugGasLimit" value="300000" 
                           class="w-full bg-black/30 border border-gray-600 rounded-lg px-4 py-3 text-white">
                </div>
            </div>
            <div class="flex space-x-4 mt-6">
                <button id="debugCreateBtn" class="bg-green-500 hover:bg-green-600 px-6 py-3 rounded-xl font-medium">
                    ğŸ§ª è°ƒè¯•åˆ›å»ºäº¤æ˜“
                </button>
                <button id="estimateGasBtn" class="bg-orange-500 hover:bg-orange-600 px-6 py-3 rounded-xl font-medium">
                    â›½ ä¼°ç®— Gas
                </button>
            </div>
        </div>

        <!-- å®æ—¶æ—¥å¿— -->
        <div class="glass-effect rounded-2xl p-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <span class="mr-3">ğŸ“</span>è°ƒè¯•æ—¥å¿—
                <button id="clearLogBtn" class="ml-auto text-sm bg-red-500 hover:bg-red-600 px-3 py-1 rounded">
                    æ¸…é™¤
                </button>
            </h2>
            <div id="debugLog" class="bg-black/40 rounded-lg p-4 h-96 overflow-y-auto debug-code text-sm">
                <div class="text-cyan-400">[ç³»ç»Ÿ] è°ƒè¯•å·¥å…·å·²åŠ è½½</div>
            </div>
        </div>
    </div>

    <script>
        let provider, signer, connected = false;
        let userAccount = '';

        // æ—¥å¿—å‡½æ•°
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-white',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400',
                debug: 'text-cyan-400'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = colors[type] || 'text-white';
            logEntry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ¸…é™¤æ—¥å¿—
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('debugLog').innerHTML = '<div class="text-cyan-400">[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…é™¤</div>';
        });

        // ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
        async function checkSystemStatus() {
            addLog('å¼€å§‹ç³»ç»ŸçŠ¶æ€æ£€æŸ¥...', 'debug');
            
            // æ£€æŸ¥ MetaMask
            if (typeof window.ethereum !== 'undefined') {
                document.getElementById('metamaskStatus').innerHTML = 'âœ… å·²å®‰è£…';
                document.getElementById('metamaskStatus').className = 'text-lg font-bold text-green-400';
                addLog('MetaMask: å·²æ£€æµ‹åˆ°', 'success');
                
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        provider = new ethers.BrowserProvider(window.ethereum);
                        signer = await provider.getSigner();
                        userAccount = accounts[0];
                        connected = true;
                        
                        // æ£€æŸ¥ç½‘ç»œ
                        const network = await provider.getNetwork();
                        if (network.chainId.toString() === '11155111') {
                            document.getElementById('networkStatus').innerHTML = 'âœ… Sepolia';
                            document.getElementById('networkStatus').className = 'text-lg font-bold text-green-400';
                            addLog(`ç½‘ç»œ: Sepolia (${network.chainId})`, 'success');
                        } else {
                            document.getElementById('networkStatus').innerHTML = `âŒ é”™è¯¯ç½‘ç»œ (${network.chainId})`;
                            document.getElementById('networkStatus').className = 'text-lg font-bold text-red-400';
                            addLog(`ç½‘ç»œé”™è¯¯: å½“å‰ç½‘ç»œ ${network.chainId}, éœ€è¦ Sepolia (11155111)`, 'error');
                        }
                        
                        // æ£€æŸ¥ä½™é¢
                        const balance = await provider.getBalance(accounts[0]);
                        const balanceEth = ethers.formatEther(balance);
                        document.getElementById('balanceStatus').innerHTML = `${parseFloat(balanceEth).toFixed(4)} ETH`;
                        
                        if (parseFloat(balanceEth) > 0.01) {
                            document.getElementById('balanceStatus').className = 'text-lg font-bold text-green-400';
                            addLog(`è´¦æˆ·ä½™é¢: ${balanceEth} ETH (å……è¶³)`, 'success');
                        } else {
                            document.getElementById('balanceStatus').className = 'text-lg font-bold text-yellow-400';
                            addLog(`è´¦æˆ·ä½™é¢: ${balanceEth} ETH (å¯èƒ½ä¸è¶³)`, 'warning');
                        }
                        
                        addLog(`è¿æ¥è´¦æˆ·: ${accounts[0]}`, 'info');
                        
                    } else {
                        document.getElementById('networkStatus').innerHTML = 'âŒ æœªè¿æ¥';
                        document.getElementById('balanceStatus').innerHTML = 'âŒ æœªè¿æ¥';
                        addLog('MetaMask: å·²å®‰è£…ä½†æœªè¿æ¥', 'warning');
                    }
                } catch (error) {
                    addLog(`MetaMask æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
                }
            } else {
                document.getElementById('metamaskStatus').innerHTML = 'âŒ æœªå®‰è£…';
                document.getElementById('metamaskStatus').className = 'text-lg font-bold text-red-400';
                addLog('MetaMask: æœªå®‰è£…', 'error');
            }
            
            addLog('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ', 'debug');
        }

        // éªŒè¯åˆçº¦
        async function verifyContracts() {
            if (!connected) {
                addLog('è¯·å…ˆè¿æ¥ MetaMask', 'error');
                return;
            }
            
            addLog('å¼€å§‹éªŒè¯åˆçº¦åœ°å€...', 'debug');
            
            const contracts = {
                'vaultCreation': getContractAddress('vaultCreation'),
                'vaultInvestment': getContractAddress('vaultInvestment'), 
                'dexSwap': getContractAddress('dexSwap'),
                'dexLiquidity': getContractAddress('dexLiquidity')
            };
            
            for (const [name, address] of Object.entries(contracts)) {
                try {
                    const code = await provider.getCode(address);
                    if (code === '0x') {
                        addLog(`${name}: ${address} - âŒ ä¸æ˜¯åˆçº¦åœ°å€`, 'warning');
                    } else {
                        addLog(`${name}: ${address} - âœ… åˆçº¦å­˜åœ¨`, 'success');
                    }
                } catch (error) {
                    addLog(`${name}: ${address} - âŒ éªŒè¯å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            addLog('åˆçº¦éªŒè¯å®Œæˆ', 'debug');
        }

        // Gas ä¼°ç®—
        async function estimateGas() {
            if (!connected) {
                addLog('è¯·å…ˆè¿æ¥ MetaMask', 'error');
                return;
            }
            
            const projectName = document.getElementById('debugProjectName').value;
            const creationFee = document.getElementById('debugCreationFee').value;
            
            addLog('å¼€å§‹ Gas ä¼°ç®—...', 'debug');
            
            try {
                const tx = {
                    to: getContractAddress('vaultCreation'),
                    value: ethers.parseEther(creationFee),
                    data: '0x' + btoa(JSON.stringify({
                        name: projectName,
                        category: 'Technology',
                        goal: '100',
                        duration: '30'
                    })).split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('')
                };
                
                const gasEstimate = await provider.estimateGas(tx);
                addLog(`Gas ä¼°ç®—: ${gasEstimate.toString()} gas`, 'success');
                
                const gasPrice = await provider.getFeeData();
                addLog(`Gas Price: ${ethers.formatUnits(gasPrice.gasPrice, 'gwei')} gwei`, 'info');
                
                const totalCost = ethers.formatEther(gasEstimate * gasPrice.gasPrice);
                addLog(`æ€» Gas è´¹ç”¨: ${totalCost} ETH`, 'info');
                
                document.getElementById('debugGasLimit').value = (parseInt(gasEstimate.toString()) * 1.2).toFixed(0);
                
            } catch (error) {
                addLog(`Gas ä¼°ç®—å¤±è´¥: ${error.message}`, 'error');
                if (error.reason) {
                    addLog(`é”™è¯¯åŸå› : ${error.reason}`, 'error');
                }
                if (error.code) {
                    addLog(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
                }
            }
        }

        // è°ƒè¯•åˆ›å»ºäº¤æ˜“
        async function debugCreateTransaction() {
            if (!connected) {
                addLog('è¯·å…ˆè¿æ¥ MetaMask', 'error');
                return;
            }
            
            const projectName = document.getElementById('debugProjectName').value;
            const creationFee = document.getElementById('debugCreationFee').value;
            const gasLimit = document.getElementById('debugGasLimit').value;
            
            addLog('å¼€å§‹è°ƒè¯•åˆ›å»ºé¡¹ç›®äº¤æ˜“...', 'debug');
            addLog(`é¡¹ç›®åç§°: ${projectName}`, 'info');
            addLog(`åˆ›å»ºè´¹ç”¨: ${creationFee} ETH`, 'info');
            addLog(`Gas é™åˆ¶: ${gasLimit}`, 'info');
            
            try {
                // æ„å»ºäº¤æ˜“
                const tx = {
                    to: getContractAddress('vaultCreation'),
                    value: ethers.parseEther(creationFee),
                    gasLimit: gasLimit,
                    data: '0x' + btoa(JSON.stringify({
                        name: projectName,
                        category: 'Technology',
                        goal: '100',
                        duration: '30'
                    })).split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('')
                };
                
                addLog(`ç›®æ ‡åˆçº¦: ${tx.to}`, 'info');
                addLog(`äº¤æ˜“ä»·å€¼: ${ethers.formatEther(tx.value)} ETH`, 'info');
                addLog(`æ•°æ®é•¿åº¦: ${tx.data.length} å­—ç¬¦`, 'info');
                
                addLog('å‘é€äº¤æ˜“åˆ° MetaMask...', 'debug');
                const transaction = await signer.sendTransaction(tx);
                addLog(`äº¤æ˜“å·²æäº¤: ${transaction.hash}`, 'success');
                
                addLog('ç­‰å¾…äº¤æ˜“ç¡®è®¤...', 'debug');
                const receipt = await transaction.wait();
                
                if (receipt && receipt.status === 1) {
                    addLog(`âœ… äº¤æ˜“æˆåŠŸ! åŒºå—: ${receipt.blockNumber}`, 'success');
                    addLog(`Gas ä½¿ç”¨: ${receipt.gasUsed.toString()}`, 'info');
                    addLog(`å®é™…è´¹ç”¨: ${ethers.formatEther(receipt.gasUsed * receipt.gasPrice || 0)} ETH`, 'info');
                } else {
                    addLog(`âŒ äº¤æ˜“å¤±è´¥! çŠ¶æ€: ${receipt.status}`, 'error');
                }
                
            } catch (error) {
                addLog(`âŒ äº¤æ˜“æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                
                if (error.code === 4001) {
                    addLog('ç”¨æˆ·å–æ¶ˆäº†äº¤æ˜“', 'warning');
                } else if (error.code === 'INSUFFICIENT_FUNDS') {
                    addLog('ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜äº¤æ˜“è´¹ç”¨', 'error');
                } else if (error.code === -32000) {
                    addLog('äº¤æ˜“ä¼šå¤±è´¥ - è¯·æ£€æŸ¥åˆçº¦åœ°å€å’Œå‚æ•°', 'error');
                } else if (error.reason) {
                    addLog(`å¤±è´¥åŸå› : ${error.reason}`, 'error');
                }
                
                if (error.transaction) {
                    addLog(`äº¤æ˜“è¯¦æƒ…: ${JSON.stringify(error.transaction, null, 2)}`, 'debug');
                }
            }
        }

        // äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('checkSystemBtn').addEventListener('click', checkSystemStatus);
        document.getElementById('verifyContractsBtn').addEventListener('click', verifyContracts);
        document.getElementById('estimateGasBtn').addEventListener('click', estimateGas);
        document.getElementById('debugCreateBtn').addEventListener('click', debugCreateTransaction);

        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            addLog('è°ƒè¯•å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'debug');
            checkSystemStatus();
        });
    </script>
</body>
</html>